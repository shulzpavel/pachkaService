groups:
  - name: pachka-service-alerts
    rules:
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Alertmanager недоступен >1м"
          description: "Доставка алертов остановлена. Проверь контейнер alertmanager (порт 9093), логи и сеть."

      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Prometheus недоступен >1м"
          description: "Сбор метрик остановлен, правила не сработают. Проверь контейнер prometheus (порт 9090) и volumes."

      - alert: ServiceDown
        expr: up{job="pachka-services"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Сервис {{ $labels.instance }} недоступен >1м'
          description: 'Контейнер {{ $labels.instance }} не отвечает более 1 минуты. Пользователи не получают ответы. Проверь логи контейнера и healthcheck, перезапусти сервис.'

      - alert: GatewayHighErrorRate
        expr: (sum(rate(http_requests_total{service="gateway",status=~"5.."}[5m])) / sum(rate(http_requests_total{service="gateway"}[5m]))) > 0.05
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: 'Ошибки 5xx на gateway >5% за 5м'
          description: 'Gateway отдаёт >5% 5xx за последние 5 минут. Вебхуки Jira могут не доходить. Проверь логи gateway и доступность router/notifier, внешние API.'

      - alert: Http404Detected
        expr: rate(http_requests_total{status="404",path="/jira/webhook"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: '404 на webhook: {{ $labels.method }} {{ $labels.path }}'
          description: 'За последние 5 минут фиксируются 404 на /jira/webhook. Проверь конфигурацию Jira webhook и маршруты. Метки: service={{ $labels.service }}, method={{ $labels.method }}, path={{ $labels.path }}.'

      - alert: High4xxRate
        expr: (sum by (service) (rate(http_requests_total{status=~"4..",status!~"404"}[5m])) / sum by (service) (rate(http_requests_total[5m]))) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Высокая доля 4xx на {{ $labels.service }} (>5%)'
          description: 'Доля 4xx (кроме 404) на {{ $labels.service }} превышает 5% за 5 минут. Проверь валидацию, формат запросов и клиентов.'

      - alert: Webhook400Spike
        expr: rate(http_requests_total{service="gateway",path="/jira/webhook",status="400"}[5m]) > 0.02
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Всплеск 400 на /jira/webhook'
          description: 'На gateway растёт число 400 на /jira/webhook. Проверь валидность payload и формат запроса Jira.'

      - alert: GatewayHighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="gateway"}[5m])) by (le)) > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: 'Медленные ответы gateway (p95 > 1s)'
          description: '95-й перцентиль ответа gateway >1s за 5 минут. Пользователи видят задержки. Проверь нагрузку, сети, логи gateway и downstream (router/notifier).' 

      - alert: RouterForwardErrors
        expr: rate(forward_requests_total{service="gateway",target="router",status="error"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Gateway не может достучаться до router'
          description: 'Gateway получает ошибки при вызове router. Вебхуки Jira не маршрутизируются. Проверь контейнер router, сеть внутри docker, healthcheck.'

      - alert: NotifierForwardErrors
        expr: rate(forward_requests_total{service="gateway",target="notifier",status="error"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Gateway не может достучаться до notifier'
          description: 'Gateway получает ошибки при вызове notifier. Уведомления не отправятся в Пачку. Проверь контейнер notifier, сеть, healthcheck.'

      - alert: PachkaSendErrors
        expr: rate(forward_requests_total{service="notifier",target="pachka",status="error"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: 'Не отправляются сообщения в Пачку'
          description: 'Notifier получает ошибки от API Пачки (429/5xx). Сообщения не доставляются. Проверь токен, лимиты, доступ к api.pachca.com, логи notifier.'

      - alert: BreakerOpen
        expr: gateway_circuit_breaker_state == 2 or notifier_circuit_breaker_state == 2
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: 'Circuit breaker открыт ({{ $labels.target }})'
          description: 'Сработал circuit breaker для {{ $labels.target }}. Запросы временно блокируются после серии ошибок. Проверь доступность downstream и логи сервиса.'

      - alert: BreakerHalfOpenTooLong
        expr: gateway_circuit_breaker_state == 1 or notifier_circuit_breaker_state == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Circuit breaker в HALF_OPEN слишком долго ({{ $labels.target }})'
          description: 'Circuit breaker остаётся в HALF_OPEN более 2 минут. Возможен флаппинг downstream. Проверь стабильность router/notifier/pachka.'

      - alert: PachkaApiLatencyP95
        expr: histogram_quantile(0.95, sum(rate(forward_request_duration_seconds_bucket{service="notifier",target="pachka",result="ok"}[5m])) by (le)) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Высокая задержка Pachka API (p95 > 2s)'
          description: 'Pachka API отвечает медленно (p95 > 2s). Возможны задержки доставки уведомлений. Проверь сеть и статус api.pachca.com.'

      - alert: GatewayInFlightSaturated
        expr: gateway_in_flight >= gateway_max_concurrency
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Gateway упёрся в лимит параллелизма'
          description: 'gateway_in_flight стабильно равен лимиту gateway_max_concurrency. Возможен рост очереди. Проверь нагрузку и настройку GATEWAY_CONCURRENCY.'

      - alert: GatewayQueueHigh
        expr: gateway_queue_length > 150
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Очередь gateway растёт (>150 задач)'
          description: 'Длина очереди gateway {{ $value }}. Вебхуки могут тормозить. Проверь нагрузку, лимиты и downstream (router/notifier).'

      - alert: GatewayQueueOverflow
        expr: increase(gateway_queue_overflow_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Переполнение очереди gateway'
          description: 'За последние 5 минут зафиксированы отказы из-за переполнения очереди gateway. Проверь нагрузку и параметры GATEWAY_CONCURRENCY/GATEWAY_MAX_QUEUE.'

      - alert: NotifierQueueHigh
        expr: notifier_queue_length > 200
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Очередь notifier растёт (>200 задач)'
          description: 'Длина очереди notifier {{ $value }}. Отправки в Пачку не успевают. Проверь сетевые проблемы/лимиты Пачки, увеличь NOTIFIER_CONCURRENCY или разберись с rate limit.'
